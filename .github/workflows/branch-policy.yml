name: Branch Policy

on:
  # Trigger on PRs to strictly validate titles
  pull_request:
    types: [opened, edited, reopened, synchronize]
    branches: [develop, 'release/**', main]

  # Trigger on Push to "police" branch creation
  # (Cannot block the push without Paid plan, but fail immediately to alert dev)
  push:
    branches-ignore:
      - main
      - develop
      - 'release/**'
      - 'v*' # tags

jobs:
  check-branch-naming:
    name: Enforce Branch Naming
    runs-on: ubuntu-latest
    steps:
      - name: Verify Branch Name
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          echo "Verifying branch: $BRANCH_NAME"
          
          # Allow valid patterns: feature/*, bugfix/*, hotfix/*, support/*, release/*
          if [[ "$BRANCH_NAME" =~ ^feature/ ]]; then
            echo "✅ Valid feature branch."
          elif [[ "$BRANCH_NAME" =~ ^bugfix/ ]]; then
            echo "✅ Valid bugfix branch."
          elif [[ "$BRANCH_NAME" =~ ^hotfix/ ]]; then
             echo "✅ Valid hotfix branch."
          elif [[ "$BRANCH_NAME" =~ ^support/ ]]; then
             echo "✅ Valid support branch."
          elif [[ "$BRANCH_NAME" =~ ^release/ ]]; then
             echo "✅ Valid release branch."
          else
            echo "❌ ERROR: Invalid branch name '$BRANCH_NAME'."
            echo "Allowed prefixes: feature/, bugfix/, hotfix/, support/, release/"
            exit 1
          fi

  check-pr-title:
    name: Validate PR Title (Conventional Commits)
    # Only run this job on Pull Requests
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false

name: Release Handler

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  release-orchestrator:
    name: Check & Tag
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.check.outputs.is_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Release Commit
        id: check
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit Message: $COMMIT_MSG"
          
          # Match "chore(release): v..."
          if [[ "$COMMIT_MSG" =~ chore\(release\):\ (v[0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION=${BASH_REMATCH[1]}
            echo "âœ… Detected Release Version: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ Not a release commit. Skipping."
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Git Tag
        if: steps.check.outputs.is_release == 'true'
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag $VERSION
          git push origin $VERSION
          echo "âœ… Tagged repo with $VERSION"

  build-and-publish:
    name: Build & Publish
    needs: release-orchestrator
    if: needs.release-orchestrator.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Use the detected version
      - name: Set Version Env
        run: echo "VERSION=${{ needs.release-orchestrator.outputs.version }}" >> $GITHUB_ENV

      # Step 1: Build Executables
      - name: Build Executable (Linux)
        run: |
          mkdir -p build
          echo "Binary content for $VERSION" > build/app-linux
          chmod +x build/app-linux
          
      - name: Build Executable (Windows)
        run: |
          echo "Binary content for $VERSION" > build/app-windows.exe

      # Step 2: Docker
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and Push Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ needs.release-orchestrator.outputs.version }}
            ghcr.io/${{ github.repository }}:latest

      # Step 3: GitHub Release
      - name: Generate Changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
           configuration: |
            {
              "categories": [
                {"title": "## ğŸš€ Features", "labels": ["feat"]},
                {"title": "## ğŸ› Fixes", "labels": ["fix"]},
                {"title": "## ğŸ§ª Tests", "labels": ["test"]},
                {"title": "## ğŸ“¦ Build", "labels": ["build", "ci"]}
              ]
            }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.release-orchestrator.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          files: |
            build/app-linux
            build/app-windows.exe
